<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AniLytics - Rice Distribution Monitor</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>AniLytics</h1>
                <span>Rice Distribution Monitor</span>
            </div>
            <div class="nav-menu" id="navMenu">
                <a href="/" class="nav-link active">üè† Dashboard</a>
                <a href="/input" class="nav-link">‚ûï Add Data</a>
                <a href="/analytics" class="nav-link">üìà Analytics</a>
                <a href="/history" class="nav-link">üïë Progress</a>
                <a href="/logout" class="nav-link" style="margin-left:auto">üö™ Logout</a>
            </div>
            <div class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="dashboard-header">
                <h2>Rice Distribution Dashboard</h2>
                <p>Monitor your rice sales, track waste, and get AI-powered recommendations</p>
            </div>

            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div class="flash-container" aria-live="polite" aria-atomic="true">
                  {% for category, message in messages %}
                    <div class="alert {{ 'alert-success' if category in ['success','info'] else 'alert-error' }}">{{ message }}</div>
                  {% endfor %}
                </div>
              {% endif %}
            {% endwith %}

            <!-- Year/Month Selection -->
            <div class="year-selection">
                <label for="dashboardYear">Select Year:</label>
                <select id="dashboardYear">
                    <option value="">All Years</option>
                    <option value="2024">2024</option>
                    <option value="2025" selected>2025</option>
                    <option value="2026">2026</option>
                    <option value="2027">2027</option>
                </select>

                <label for="dashboardMonth">Month:</label>
                <select id="dashboardMonth">
                    <option value="">All Months</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>
                </select>

                <label for="dashboardPeriod">View:</label>
                <select id="dashboardPeriod">
                    <option value="week" selected>Per Week</option>
                    <option value="month">Per Month</option>
                    <option value="year">Per Year</option>
                </select>
                <button id="dashboardApply" class="btn-primary" type="button">Apply</button>
                <button id="dashboardReset" class="btn-secondary" type="button">Reset</button>
                <div class="year-info">
                    <strong>Current View:</strong> <span id="currentYearView">All Years</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-content">
                        <h3 id="totalEntries">0</h3>
                        <p>Total Records</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üåæ</div>
                    <div class="stat-content">
                        <h3 id="totalSold">0 kg</h3>
                        <p>Rice Sold</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-content">
                        <h3 id="totalRevenue">‚Ç±0</h3>
                        <p>Total Revenue</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-content">
                        <h3 id="efficiencyScore">-</h3>
                        <p>Efficiency Score</p>
                    </div>
                </div>
            </div>

            <div class="charts-grid">
                <div class="chart-card">
                    <h3>Weekly Sales Overview</h3>
                    <canvas id="salesChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3>Waste Percentage Trends</h3>
                    <canvas id="wasteChart"></canvas>
                </div>
            </div>

            <div class="recent-data">
                <h3>Recent Sales Data</h3>
                <div class="data-table-container">
                    <table class="data-table" id="recentDataTable">
                        <thead>
                            <tr>
                                <th>Week</th>
                                <th>Sold (kg)</th>
                                <th>Unsold (kg)</th>
                                <th>Price/kg</th>
                                <th>Waste %</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="recentDataBody">
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="prediction-section">
                <h3>Rice Demand Prediction</h3>
                <form id="predictionForm" class="prediction-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="population">Population</label>
                            <input type="number" id="population" name="population" required>
                        </div>
                        <div class="form-group">
                            <label for="avgConsumption">Avg Consumption (kg/person/week)</label>
                            <input type="number" id="avgConsumption" name="avgConsumption" step="0.1" required>
                        </div>
                        <div class="form-group">
                            <label for="purchasingPower">Purchasing Power (0-1)</label>
                            <input type="number" id="purchasingPower" name="purchasingPower" step="0.1" min="0" max="1" required>
                        </div>
                        <div class="form-group">
                            <label for="competitors">Number of Competitors</label>
                            <input type="number" id="competitors" name="competitors" min="0" required>
                        </div>
                    </div>
                    <button type="submit" class="btn-primary">Calculate Demand</button>
                </form>
                
                <div id="predictionResults" class="prediction-results" style="display: none;">
                    <h4>Prediction Results</h4>
                    <div class="result-card">
                        <p><strong>Predicted Demand:</strong> <span id="predictedDemand"></span> kg/week</p>
                        <p><strong>Formula Used:</strong> <span id="formulaUsed"></span></p>
                    </div>
                    <div class="recommendations" id="recommendations"></div>
                </div>
            </div>
        </div>
    </main>

    <div id="deleteModalOverlay" class="modal-overlay" style="display:none">
      <div class="modal">
        <h3>Are you sure you want to delete this entry?</h3>
        <div class="modal-actions">
          <button class="btn btn-cancel" id="cancelDeleteBtn" type="button">Cancel</button>
          <button class="btn btn-danger" id="confirmDeleteBtn" type="button">Delete</button>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Dashboard selection label helper (no data fetch here; fetching is handled in static/script.js)
        function updateDashboardYear() {
            const year = document.getElementById('dashboardYear').value;
            const month = document.getElementById('dashboardMonth').value;
            const yearView = document.getElementById('currentYearView');

            const monthNames = [
                '', 'January','February','March','April','May','June','July','August','September','October','November','December'
            ];

            if (year && month) {
                yearView.textContent = `Year ${year} - ${monthNames[Number(month)]}`;
            } else if (year) {
                yearView.textContent = `Year ${year}`;
            } else {
                yearView.textContent = 'All Years';
            }
        }

        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            // Auto-hide any flashed alerts after a few seconds
            setTimeout(() => { document.querySelectorAll('.alert').forEach(el => el.style.display = 'none') }, 4000)
            loadAvailableYears();
            updateDashboardYear();
            const yearSel = document.getElementById('dashboardYear');
            const monthSel = document.getElementById('dashboardMonth');
            const periodSel = document.getElementById('dashboardPeriod');
            if (yearSel) yearSel.addEventListener('change', updateDashboardYear);
            if (monthSel) monthSel.addEventListener('change', updateDashboardYear);
            if (periodSel) periodSel.addEventListener('change', updateDashboardYear);
        });

        async function loadAvailableYears() {
            try {
                const response = await fetch('/api/available-years');
                const data = await response.json();
                
                if (data.years && data.years.length > 0) {
                    const yearSelect = document.getElementById('dashboardYear');
                    yearSelect.innerHTML = '<option value="">All Years</option>';
                    
                    data.years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === 2025) option.selected = true;
                        yearSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading available years:', error);
            }
        }
    </script>
</body>
</html>
