<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Analytics - AniLytics</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <div class="nav-brand">
                <h1>AniLytics</h1>
                <span>Rice Distribution Monitor</span>
            </div>
            <div class="nav-menu" id="navMenu">
                <a href="/" class="nav-link">üè† Dashboard</a>
                <a href="/input" class="nav-link">‚ûï Add Data</a>
                <a href="/analytics" class="nav-link active">üìà Analytics</a>
                <a href="/history" class="nav-link">üïë Progress</a>
                <a href="/logout" class="nav-link" style="margin-left:auto">üö™ Logout</a>
            </div>
            <div class="nav-toggle" id="navToggle">
                <span></span>
                <span></span>
                <span></span>
            </div>
        </div>
    </nav>

    <main class="main-content">
        <div class="container">
            <div class="analytics-header">
                <h2>Advanced Analytics & Insights</h2>
                <p>Comprehensive analysis of rice distribution patterns, trends, and predictive insights</p>
            </div>
            <div id="errorBanner" style="display:none;margin:10px 0;padding:10px;border:1px solid #dc3545;color:#842029;background:#f8d7da;border-radius:6px;"></div>

            <!-- Time Period Selection -->
            <div class="analytics-section">
                <h3>Time Period Selection</h3>
                <div class="time-controls">
                    <div class="control-group">
                        <label for="analyticsYear">Year:</label>
                        <select id="analyticsYear" onchange="updateAnalyticsPeriod()">
                            <option value="">All Years</option>
                            <option value="2024">2024</option>
                            <option value="2025" selected>2025</option>
                            <option value="2026">2026</option>
                            <option value="2027">2027</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label for="analyticsMonth">Month:</label>
                        <select id="analyticsMonth" onchange="updateAnalyticsPeriod()">
                            <option value="">All Months</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                                            <div class="control-group">
                            <label for="analyticsWeek">Week:</label>
                            <select id="analyticsWeek" onchange="updateAnalyticsPeriod()">
                                <option value="">All Weeks</option>
                                <option value="1">Week 1 (1-7)</option>
                                <option value="2">Week 2 (8-14)</option>
                                <option value="3">Week 3 (15-21)</option>
                                <option value="4">Week 4 (22-28)</option>
                                <option value="5">Week 5 (29-31)</option>
                            </select>
                        </div>
                    <div class="control-group">
                        <button onclick="applyTimeFilter()" class="btn-primary">Apply Filter</button>
                        <button onclick="resetTimeFilter()" class="btn-secondary">Reset</button>
                    </div>
                </div>
                <div class="period-info">
                    <strong>Current Period:</strong> <span id="currentPeriod">All data</span>
                </div>
            </div>

            <!-- Data Quality Overview -->
            <div class="analytics-section">
                <h3>Data Quality Assessment</h3>
                <div class="quality-grid" id="qualityGrid">
                    <div class="quality-card">
                        <div class="quality-icon">üìä</div>
                        <div class="quality-content">
                            <h4>Data Completeness</h4>
                            <div class="quality-score" id="completenessScore">-</div>
                        </div>
                    </div>
                    <div class="quality-card">
                        <div class="quality-icon">‚úÖ</div>
                        <div class="quality-content">
                            <h4>Valid Records</h4>
                            <div class="quality-score" id="validRecords">-</div>
                        </div>
                    </div>
                    <div class="quality-card">
                        <div class="quality-icon">‚ö†Ô∏è</div>
                        <div class="quality-content">
                            <h4>Issues Found</h4>
                            <div class="quality-score" id="issuesFound">-</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Trend Analysis -->
            <div class="analytics-section">
                <h3>Trend Analysis</h3>
                <div class="trends-grid">
                    <div class="trend-card">
                        <h4>Sales Trend</h4>
                        <div class="trend-indicator" id="salesTrendIndicator">
                            <span class="trend-value" id="salesTrendValue">-</span>
                            <span class="trend-direction" id="salesTrendDirection">-</span>
                        </div>
                        <small>Change per week</small>
                    </div>
                    <div class="trend-card">
                        <h4>Waste Trend</h4>
                        <div class="trend-indicator" id="wasteTrendIndicator">
                            <span class="trend-value" id="wasteTrendValue">-</span>
                            <span class="trend-direction" id="wasteTrendDirection">-</span>
                        </div>
                        <small>Change per week</small>
                    </div>
                    <div class="trend-card">
                        <h4>Price Trend</h4>
                        <div class="trend-indicator" id="priceTrendIndicator">
                            <span class="trend-value" id="priceTrendValue">-</span>
                            <span class="trend-direction" id="priceTrendDirection">-</span>
                        </div>
                        <small>Change per week</small>
                    </div>
                    <div class="trend-card">
                        <h4>Efficiency Trend</h4>
                        <div class="trend-indicator" id="efficiencyTrendIndicator">
                            <span class="trend-value" id="efficiencyTrendValue">-</span>
                            <span class="trend-direction" id="efficiencyTrendDirection">-</span>
                        </div>
                        <small>Change per week</small>
                    </div>
                </div>
                
                <div class="chart-container">
                    <h4>Moving Averages</h4>
                    <canvas id="movingAverageChart"></canvas>
                </div>
            </div>

            <!-- Correlation Analysis -->
            <div class="analytics-section">
                <h3>Correlation Analysis</h3>
                <p>Understanding relationships between different factors affecting rice distribution</p>
                
                <div class="correlation-grid" id="correlationGrid">
                    <!-- Correlation cards will be populated by JavaScript -->
                </div>
                
                <div class="chart-container">
                    <h4>Price vs. Demand Correlation</h4>
                    <canvas id="correlationChart"></canvas>
                </div>
            </div>

            <!-- Market Comparison -->
            <div class="analytics-section">
                <h3>Market Performance Comparison</h3>
                <p>Comparing efficiency and performance across different market locations</p>
                
                <div class="market-comparison-grid" id="marketComparisonGrid">
                    <!-- Market comparison cards will be populated by JavaScript -->
                </div>
                
                <div class="chart-container">
                    <h4>Market Efficiency Comparison</h4>
                    <canvas id="marketEfficiencyChart"></canvas>
                </div>
            </div>

            <!-- Forecasting -->
            <div class="analytics-section">
                <h3>Demand Forecasting</h3>
                <p>AI-powered predictions for future rice demand and inventory planning</p>
                
                <div class="forecast-controls">
                    <label for="forecastWeeks">Forecast Period:</label>
                    <select id="forecastWeeks">
                        <option value="2">2 Weeks</option>
                        <option value="4" selected>4 Weeks</option>
                        <option value="8">8 Weeks</option>
                    </select>
                    <button onclick="generateForecast()" class="btn-primary">Generate Forecast</button>
                </div>
                
                <div class="forecast-results" id="forecastResults" style="display: none;">
                    <h4>Forecast Results</h4>
                    <div class="forecast-table-container">
                        <table class="forecast-table" id="forecastTable">
                            <thead>
                                <tr>
                                    <th>Week</th>
                                    <th>Predicted Sold (kg)</th>
                                    <th>Predicted Unsold (kg)</th>
                                    <th>Waste %</th>
                                    <th>Confidence</th>
                                </tr>
                            </thead>
                            <tbody id="forecastTableBody">
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="forecast-chart-container">
                        <canvas id="forecastChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Weekly Patterns -->
            <div class="analytics-section">
                <h3>Weekly Patterns & Seasonality</h3>
                <p>Understanding day-of-week patterns in rice consumption</p>
                
                <div class="weekly-patterns-grid" id="weeklyPatternsGrid">
                    <!-- Weekly pattern cards will be populated by JavaScript -->
                </div>
                
                <div class="chart-container">
                    <h4 id="weeklyPatternsTitle">Sales Patterns</h4>
                    <canvas id="weeklyPatternsChart"></canvas>
                </div>
            </div>

            <!-- Research Insights -->
            <div class="analytics-section">
                <h3>Research Insights & Recommendations</h3>
                <p>Data-driven insights for improving rice distribution efficiency</p>
                
                <div class="insights-grid" id="insightsGrid">
                    <!-- Insights will be populated by JavaScript -->
                </div>
            </div>
        </div>
    </main>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        // Keep a handle to the correlation chart so we can destroy between reloads
        let correlationChartInstance = null;
        let movingAverageChartInstance = null;
        let weeklyPatternsChartInstance = null;
        let marketEfficiencyChartInstance = null;
        let forecastChartInstance = null;

        // JSON fetch helper delegating to global safeFetchJson with timeout support
        async function getJson(url, timeout = 15000) {
            // Delegate to global safeFetchJson (loaded from static/script.js) while preserving timeout behavior
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), timeout);
            try {
                return await safeFetchJson(url, { signal: controller.signal });
            } catch (e) {
                console.error('Fetch failed:', url, e);
                return { error: e && e.message ? e.message : 'Fetch error' };
            } finally {
                clearTimeout(id);
            }
        }
        function showErrorBanner(message) {
            const el = document.getElementById('errorBanner');
            if (!el) return;
            el.textContent = message || 'A network or server error occurred. Please try again.';
            el.style.display = 'block';
        }
        function clearErrorBanner() {
            const el = document.getElementById('errorBanner');
            if (!el) return;
            el.style.display = 'none';
            el.textContent = '';
        }
        // Load analytics data when page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadAvailableYears();
            loadAnalyticsData();
            updateAnalyticsPeriod();
        });

        async function loadAvailableYears() {
            try {
                const data = await getJson('/api/available-years', 15000);
                if (data.error) {
                    console.error('Error loading available years:', data.error);
                    return;
                }
                if (data.years && data.years.length > 0) {
                    const yearSelect = document.getElementById('analyticsYear');
                    yearSelect.innerHTML = '<option value="">All Years</option>';
                    
                    data.years.forEach(year => {
                        const option = document.createElement('option');
                        option.value = year;
                        option.textContent = year;
                        if (year === 2025) option.selected = true;
                        yearSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading available years:', error);
            }
        }

        // Time period control functions
        function updateAnalyticsPeriod() {
            const year = document.getElementById('analyticsYear').value;
            const month = document.getElementById('analyticsMonth').value;
            const week = document.getElementById('analyticsWeek').value;
            
            let periodText = 'All data';
            if (year && month && week) {
                const monthName = getMonthName(parseInt(month));
                const startDay = (parseInt(week) - 1) * 7 + 1;
                const endDay = Math.min(parseInt(week) * 7, new Date(parseInt(year), parseInt(month), 0).getDate());
                periodText = `Week ${week} (${startDay}-${endDay}) of ${monthName} ${year}`;
            } else if (year && month) {
                periodText = `${getMonthName(parseInt(month))} ${year}`;
            } else if (year) {
                periodText = `Year ${year}`;
            }
            
            document.getElementById('currentPeriod').textContent = periodText;
        }

        function getMonthName(month) {
            const months = [
                '', 'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            return months[month];
        }

        function applyTimeFilter() {
            const year = document.getElementById('analyticsYear').value;
            const month = document.getElementById('analyticsMonth').value;
            const week = document.getElementById('analyticsWeek').value;
            
            // Reload analytics data with time filter
            loadAnalyticsData(year, month, week);
        }

        function resetTimeFilter() {
            document.getElementById('analyticsYear').value = '';
            document.getElementById('analyticsMonth').value = '';
            document.getElementById('analyticsWeek').value = '';
            updateAnalyticsPeriod();
            loadAnalyticsData();
        }

        async function loadAnalyticsData(year = '', month = '', week = '') {
            try {
                // Build query parameters for time filtering
                const params = new URLSearchParams();
                if (year) params.append('year', year);
                if (month) params.append('month', month);
                if (week) params.append('week', week);
                // Do not force strict filtering; allow backend fallbacks to include broader aggregates
                
                const queryString = params.toString();
                const baseUrl = queryString ? `?${queryString}` : '';

                // Use safe JSON fetches with timeouts so one slow API won't block others
                const [quality, trends, correlations, marketComparison, analyticsSummary, rawSales] = await Promise.all([
                    getJson(`/api/data-quality${baseUrl}`, 15000),
                    getJson(`/api/trends${baseUrl}`, 15000),
                    getJson(`/api/correlations${baseUrl}`, 15000),
                    getJson(`/api/market-comparison${baseUrl}`, 15000),
                    getJson(`/api/analytics${baseUrl}`, 15000),
                    getJson(`/api/sales${baseUrl}`, 15000)
                ]);

                // Error banner handling
                const benignMessages = new Set([
                    'Insufficient data for trend analysis',
                    'Insufficient data for correlation analysis',
                    'No data available for market comparison'
                ]);
                const errors = [quality, trends, correlations, marketComparison, analyticsSummary, rawSales]
                    .filter(x => x && x.error && !benignMessages.has(String(x.error)))
                    .map(x => x.error);
                if (errors.length) {
                    showErrorBanner(`Some analytics failed to load: ${errors.join('; ')}`);
                } else {
                    clearErrorBanner();
                }

                updateDataQuality(quality);
                updateTrendAnalysis(trends);
                updateCorrelationAnalysis(correlations);
                updateMarketComparison(marketComparison);
                // Expose for fallback logic and other scripts
                window.analyticsSummary = (analyticsSummary && !analyticsSummary.error) ? analyticsSummary : null;
                window.trends = (trends && !trends.error) ? trends : null;
                window.marketComparison = (marketComparison && !marketComparison.error) ? marketComparison : null;
                createAdvancedCharts(trends, correlations, marketComparison, analyticsSummary, rawSales);
                if (analyticsSummary && !analyticsSummary.error) {
                    // Populate insights using analytics summary and trends (local heuristic, no external API)
                    const data = analyticsSummary;
                    const t = trends || {};
                    const insightsGrid = document.getElementById('insightsGrid');
                    if (insightsGrid) {
                        const dir = (v) => v > 0 ? 'increasing' : v < 0 ? 'decreasing' : 'stable';
                        const insights = [
                            { title: 'Efficiency', content: `Efficiency score: ${data.efficiency_score}. Waste rate ${data.waste_percentage}%.` },
                            { title: 'Trends', content: `Sales trend is ${dir(t.sales_trend)}; price trend is ${dir(t.price_trend)}; efficiency trend is ${dir(t.efficiency_trend)}.` },
                            { title: 'Revenue & Pricing', content: `Total revenue ‚Ç±${data.total_revenue}. Average price ‚Ç±${data.avg_price} per kg.` },
                            { title: 'Actionable Tip', content: data.waste_percentage > 20 ? 'Waste is high‚Äîconsider lowering orders or promoting discounts.' : 'Waste is under control‚Äîmaintain current ordering and pricing.' }
                        ];
                        insightsGrid.innerHTML = insights.map(i => `<div class="insight-card"><h4>${i.title}</h4><p>${i.content}</p></div>`).join('');
                    }
                }
            } catch (error) {
                console.error('Error loading analytics data:', error);
            }
        }

        function updateDataQuality(quality) {
            if (quality.error) return;
            
            document.getElementById('completenessScore').textContent = `${quality.data_quality_score.toFixed(1)}%`;
            document.getElementById('validRecords').textContent = quality.complete_records;
            document.getElementById('issuesFound').textContent = quality.incomplete_records;
        }

        function updateTrendAnalysis(trends) {
            if (trends.error) return;
            
            // Update trend indicators
            updateTrendIndicator('salesTrend', trends.sales_trend, 'Sales');
            updateTrendIndicator('wasteTrend', trends.waste_trend, 'Waste');
            updateTrendIndicator('priceTrend', trends.price_trend, 'Price');
            updateTrendIndicator('efficiencyTrend', trends.efficiency_trend, 'Efficiency');
        }

        function updateTrendIndicator(prefix, value, label) {
            const valueEl = document.getElementById(`${prefix}Value`);
            const directionEl = document.getElementById(`${prefix}Direction`);
            
            if (valueEl && directionEl) {
                valueEl.textContent = Math.abs(value).toFixed(2);
                directionEl.textContent = value > 0 ? '‚ÜóÔ∏è Increasing' : value < 0 ? '‚ÜòÔ∏è Decreasing' : '‚Üí Stable';
                directionEl.className = `trend-direction ${value > 0 ? 'positive' : value < 0 ? 'negative' : 'neutral'}`;
            }
        }

        function updateCorrelationAnalysis(correlations) {
            if (correlations.error) return;
            
            const grid = document.getElementById('correlationGrid');
            grid.innerHTML = '';
            
            Object.entries(correlations.interpretations || {}).forEach(([key, interpretation]) => {
                const correlation = correlations[key] || 0;
                const card = document.createElement('div');
                card.className = 'correlation-card';
                card.innerHTML = `
                    <h4>${key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}</h4>
                    <div class="correlation-value">${correlation.toFixed(3)}</div>
                    <div class="correlation-interpretation">${interpretation}</div>
                `;
                grid.appendChild(card);
            });
        }

        function updateMarketComparison(comparison) {
            if (comparison.error) return;
            
            const grid = document.getElementById('marketComparisonGrid');
            grid.innerHTML = '';
            
            Object.entries(comparison).forEach(([market, data]) => {
                const card = document.createElement('div');
                card.className = 'market-card';
                card.innerHTML = `
                    <h4>${market}</h4>
                    <div class="market-stats">
                        <div class="stat">
                            <span class="label">Total Sold:</span>
                            <span class="value">${data.total_sold.toFixed(1)} kg</span>
                        </div>
                        <div class="stat">
                            <span class="label">Waste %:</span>
                            <span class="value">${data.avg_waste_percentage.toFixed(1)}%</span>
                        </div>
                        <div class="stat">
                            <span class="label">Avg Price:</span>
                            <span class="value">‚Ç±${data.avg_price.toFixed(2)}</span>
                        </div>
                        <div class="stat">
                            <span class="label">Efficiency:</span>
                            <span class="value efficiency-${data.efficiency_score.toLowerCase().replace(' ', '-')}">${data.efficiency_score}</span>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // Force-rebuild weekly patterns chart, replacing the canvas to avoid any stale Chart.js state
        function renderWeeklyPatternsChart(trends, rawSales) {
            try {
                const container = document.getElementById('weeklyPatternsChart') ? document.getElementById('weeklyPatternsChart').parentElement : null;
                const oldCanvas = document.getElementById('weeklyPatternsChart');
                if (!container) return;

                if (weeklyPatternsChartInstance && typeof weeklyPatternsChartInstance.destroy === 'function') {
                    try { weeklyPatternsChartInstance.destroy(); } catch (e) {}
                    weeklyPatternsChartInstance = null;
                }

                // Replace canvas node entirely to ensure a fresh drawing context
                if (oldCanvas) {
                    const newCanvas = document.createElement('canvas');
                    newCanvas.id = 'weeklyPatternsChart';
                    oldCanvas.replaceWith(newCanvas);
                }

                const ctx = document.getElementById('weeklyPatternsChart');
                // Ensure container has height so responsive charts can size properly
                if (container && container.style) container.style.height = '320px';
                if (ctx && ctx.style) ctx.style.maxHeight = '320px';

                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
                let labels = [];
                let values = [];
                if (trends && trends.weekly_patterns && Object.keys(trends.weekly_patterns).length > 0) {
                    labels = days;
                    values = days.map(day => Number.parseFloat(trends.weekly_patterns[day] || 0) || 0);
                } else if (trends && trends.week_of_month_patterns && Object.keys(trends.week_of_month_patterns).length > 0) {
                    const wkPairs = Object.keys(trends.week_of_month_patterns).map(k => {
                        const m = String(k).match(/(\d+)/);
                        return { label: k, num: m ? parseInt(m[1], 10) : 0, val: Number.parseFloat(trends.week_of_month_patterns[k] || 0) || 0 };
                    });
                    wkPairs.sort((a, b) => a.num - b.num);
                    labels = wkPairs.map(p => p.label);
                    values = wkPairs.map(p => p.val);
                } else if (trends && trends.monthly_patterns && Object.keys(trends.monthly_patterns).length > 0) {
                    const monthOrder = ['January','February','March','April','May','June','July','August','September','October','November','December'];
                    labels = monthOrder.filter(m => Object.prototype.hasOwnProperty.call(trends.monthly_patterns, m));
                    values = labels.map(m => Number.parseFloat(trends.monthly_patterns[m] || 0) || 0);
                } else if (Array.isArray(rawSales) && rawSales.length > 0) {
                    // Derive week-of-month pattern directly from raw sales when trends didn't provide it
                    const bucket = new Map(); // weekNum -> [values]
                    for (const e of rawSales) {
                        let wk = Number.isFinite(parseInt(e.week, 10)) ? parseInt(e.week, 10) : null;
                        if (!wk && e.week_date) {
                            // Accept formats like YYYY-MM-W02 or YYYY-MM-W2
                            const m = String(e.week_date).match(/-W(\d{1,2})$/);
                            if (m) wk = parseInt(m[1], 10);
                        }
                        const sold = Number.parseFloat(e.rice_sold || 0) || 0;
                        if (Number.isFinite(wk) && wk > 0) {
                            if (!bucket.has(wk)) bucket.set(wk, []);
                            bucket.get(wk).push(sold);
                        }
                    }
                    const wkNums = Array.from(bucket.keys()).sort((a,b)=>a-b);
                    if (wkNums.length) {
                        labels = wkNums.map(n => `Week ${n}`);
                        values = wkNums.map(n => {
                            const arr = bucket.get(n) || [];
                            const sum = arr.reduce((a,b)=>a+b,0);
                            return arr.length ? sum / arr.length : 0;
                        });
                    } else {
                        labels = days;
                        values = days.map(() => 0);
                    }
                } else {
                    // Fallback: render zero bars to avoid a blank canvas
                    labels = days;
                    values = days.map(() => 0);
                }

                if (!ctx || !window.Chart) return;
                weeklyPatternsChartInstance = new Chart(ctx, {
                    type: 'bar',
                    data: { labels, datasets: [{ label: 'Average Sales (kg)', data: values, backgroundColor: '#4a7c59' }] },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: (trends && ((trends.weekly_patterns && Object.keys(trends.weekly_patterns).length) || (trends.week_of_month_patterns && Object.keys(trends.week_of_month_patterns).length) || (trends.monthly_patterns && Object.keys(trends.monthly_patterns).length)))
                                    ? 'Sales Patterns'
                                    : 'Weekly Sales Patterns (no data)'
                            }
                        },
                        scales: { y: { beginAtZero: true } }
                    }
                });
                // Expose a manual rebuild helper for debugging
                window.rebuildWeeklyChart = () => renderWeeklyPatternsChart(window.trends || {}, window.rawSales || []);
            } catch (e) {
                console.error('renderWeeklyPatternsChart error:', e);
            }
        }

        function createAdvancedCharts(trends, correlations, marketComparison, analyticsSummary, rawSales) {
            // Moving Average Chart
            if (trends.sales_moving_avg && trends.waste_moving_avg) {
                const ctx = document.getElementById('movingAverageChart');
                if (ctx) {
                    if (movingAverageChartInstance && typeof movingAverageChartInstance.destroy === 'function') {
                        try { movingAverageChartInstance.destroy(); } catch (e) {}
                        movingAverageChartInstance = null;
                    }
                    movingAverageChartInstance = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: trends.sales_moving_avg.length}, (_, i) => `Week ${i + 1}`),
                            datasets: [
                                {
                                    label: 'Sales Moving Average',
                                    data: trends.sales_moving_avg,
                                    borderColor: '#4a7c59',
                                    backgroundColor: 'rgba(74, 124, 89, 0.1)',
                                    tension: 0.4
                                },
                                {
                                    label: 'Waste Moving Average',
                                    data: trends.waste_moving_avg,
                                    borderColor: '#dc3545',
                                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                    tension: 0.4
                                }
                            ]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: '3-Week Moving Averages'
                                }
                            }
                        }
                    });
                }
            }

            // Weekly/Monthly Patterns Chart: force rebuild using a dedicated helper and set title
            window.rawSales = Array.isArray(rawSales) ? rawSales : [];
            const titleEl = document.getElementById('weeklyPatternsTitle');
            if (titleEl) {
                if (trends && trends.weekly_patterns && Object.keys(trends.weekly_patterns).length) titleEl.textContent = 'Sales Patterns (Per Day of Week)';
                else if (trends && trends.week_of_month_patterns && Object.keys(trends.week_of_month_patterns).length) titleEl.textContent = 'Sales Patterns (Per Week of Month)';
                else if (trends && trends.monthly_patterns && Object.keys(trends.monthly_patterns).length) titleEl.textContent = 'Sales Patterns (Per Month)';
                else titleEl.textContent = 'Sales Patterns';
            }
            renderWeeklyPatternsChart(trends, rawSales);

            // Correlation Chart (Price vs Demand) with trendline and r, using RAW sales points for accuracy
            {
                const ctx = document.getElementById('correlationChart');
                if (ctx) {
                    // Destroy existing instance to avoid overlay
                    if (correlationChartInstance && typeof correlationChartInstance.destroy === 'function') {
                        try { correlationChartInstance.destroy(); } catch (e) {}
                        correlationChartInstance = null;
                    }

                    // Prefer raw sales (price_per_kg vs rice_sold). Fallback to analyticsSummary.chart_data if needed
                    let pts = Array.isArray(rawSales) ? rawSales
                        .map(d => ({ x: parseFloat(d.price_per_kg), y: parseFloat(d.rice_sold) }))
                        .filter(p => Number.isFinite(p.x) && Number.isFinite(p.y))
                        : [];
                    if ((!pts || pts.length === 0) && analyticsSummary && Array.isArray(analyticsSummary.chart_data)) {
                        pts = analyticsSummary.chart_data
                            .map(d => ({ x: parseFloat(d.price), y: parseFloat(d.sold) }))
                            .filter(p => Number.isFinite(p.x) && Number.isFinite(p.y));
                    }

                    // If still no points, clear canvas and skip
                    if (!pts || pts.length === 0) {
                        const c2d = ctx.getContext && ctx.getContext('2d');
                        if (c2d) c2d.clearRect(0, 0, ctx.width || ctx.clientWidth, ctx.height || ctx.clientHeight);
                        
                    } else {
                        const n = pts.length;
                        const sumX = pts.reduce((s,p)=>s+p.x,0);
                        const sumY = pts.reduce((s,p)=>s+p.y,0);
                        const sumXY = pts.reduce((s,p)=>s+p.x*p.y,0);
                        const sumX2 = pts.reduce((s,p)=>s+p.x*p.x,0);
                        const sumY2 = pts.reduce((s,p)=>s+p.y*p.y,0);
                        const denom = (n*sumX2 - sumX*sumX) || 1;
                        const slope = (n > 1) ? (n*sumXY - sumX*sumY)/denom : 0;
                        const intercept = (n > 0) ? (sumY - slope*sumX)/Math.max(n,1) : 0;
                        const rDen = Math.sqrt(Math.max((n*sumX2 - sumX*sumX),0) * Math.max((n*sumY2 - sumY*sumY),0));
                        const r = (n > 1 && rDen) ? (n*sumXY - sumX*sumY)/rDen : 0;
                        const xs = pts.map(p=>p.x);
                        const minX = Math.min(...xs);
                        const maxX = Math.max(...xs);
                        const line = (Number.isFinite(minX) && Number.isFinite(maxX))
                            ? [ { x: minX, y: slope*minX + intercept }, { x: maxX, y: slope*maxX + intercept } ]
                            : [];

                        correlationChartInstance = new Chart(ctx, {
                          type: 'scatter',
                          data: {
                            datasets: [
                              { label: 'Price vs Demand', data: pts, backgroundColor: 'rgba(74,124,89,0.6)', borderColor: '#2c5530', pointRadius: 5, pointHoverRadius: 7 },
                              { label: `Trendline (r=${(r||0).toFixed(2)})`, type: 'line', data: line, borderColor: '#8884d8', borderWidth: 2, fill: false, pointRadius: 0, tension: 0 }
                            ]
                          },
                          options: {
                            responsive: true,
                            plugins: { title: { display: true, text: 'Price vs. Demand Correlation' }, legend: { position: 'top' } },
                            scales: { x: { title: { display: true, text: 'Price (‚Ç±)' } }, y: { title: { display: true, text: 'Sold (kg)' }, beginAtZero: true } }
                          }
                        });
                    }
                }
            }

            // Market efficiency comparison chart from comparison data
            if (marketComparison && Object.keys(marketComparison).length) {
                const ctx = document.getElementById('marketEfficiencyChart');
                if (ctx) {
                    if (marketEfficiencyChartInstance && typeof marketEfficiencyChartInstance.destroy === 'function') {
                        try { marketEfficiencyChartInstance.destroy(); } catch (e) {}
                        marketEfficiencyChartInstance = null;
                    }
                    const labels = Object.keys(marketComparison);
                    const values = labels.map(k => marketComparison[k].avg_waste_percentage || 0);
                    marketEfficiencyChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Avg Waste %', data: values, backgroundColor: '#ffc107' }] }, options: { responsive: true, scales: { y: { beginAtZero: true, max: 100 } } } });
                }
            }
        }

        async function generateForecast() {
            const weeks = document.getElementById('forecastWeeks').value;
            
            try {
                const forecast = await safeFetchJson('/api/forecast', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ weeks: parseInt(weeks) })
                });
                
                if (forecast.error) {
                    alert('Error generating forecast: ' + forecast.error);
                    showErrorBanner('Error generating forecast: ' + forecast.error);
                    return;
                }
                
                displayForecast(forecast);
            } catch (error) {
                console.error('Error generating forecast:', error);
                alert('Error generating forecast. Please try again.');
                showErrorBanner('Error generating forecast. Please try again.');
            }
        }

        function displayForecast(forecast) {
            const resultsDiv = document.getElementById('forecastResults');
            const tableBody = document.getElementById('forecastTableBody');
            
            // Populate table
            tableBody.innerHTML = forecast.forecast.map(week => `
                <tr>
                    <td>${week.week}</td>
                    <td>${week.predicted_sold}</td>
                    <td>${week.predicted_unsold}</td>
                    <td>${week.predicted_waste_percentage}%</td>
                    <td><span class="confidence-${week.confidence_level.toLowerCase()}">${week.confidence_level}</span></td>
                </tr>
            `).join('');
            
            // Show results
            resultsDiv.style.display = 'block';
            
            // Create forecast chart
            const ctx = document.getElementById('forecastChart');
            if (ctx) {
                if (forecastChartInstance && typeof forecastChartInstance.destroy === 'function') {
                    try { forecastChartInstance.destroy(); } catch (e) {}
                    forecastChartInstance = null;
                }
                forecastChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: forecast.forecast.map(w => w.week),
                        datasets: [
                            {
                                label: 'Predicted Sales',
                                data: forecast.forecast.map(w => w.predicted_sold),
                                borderColor: '#4a7c59',
                                backgroundColor: 'rgba(74, 124, 89, 0.1)',
                                tension: 0.4
                            },
                            {
                                label: 'Predicted Waste',
                                data: forecast.forecast.map(w => w.predicted_unsold),
                                borderColor: '#dc3545',
                                backgroundColor: 'rgba(220, 53, 69, 0.1)',
                                tension: 0.4
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Demand Forecast'
                            }
                        }
                    }
                });
            }
        }

        // Remove fallback sample charts to avoid showing fake/stale-looking data

        // Strictly real-data-only Research Insights & Recommendations
        function generateResearchInsights(data) {
            const insightsGrid = document.getElementById('insightsGrid');
            if (!insightsGrid) return;
            // If no real data, show a message
            if (!data || !data.total_entries || data.total_entries === 0) {
                insightsGrid.innerHTML = '<div class="insight-card"><h4>No data available</h4><p>Please add rice sales data to see insights and recommendations.</p></div>';
                return;
            }
            let insights = [];
            const waste = (typeof data.waste_percentage === 'number') ? data.waste_percentage : 0;
            const efficiency = (waste < 10) ? 'Excellent' : (waste < 20) ? 'Good' : 'Needs Improvement';
            const salesTrend = (typeof data.sales_trend === 'number') ? data.sales_trend : 0;
            const priceTrend = (typeof data.price_trend === 'number') ? data.price_trend : 0;
            const totalRevenue = (typeof data.total_revenue === 'number') ? data.total_revenue : 0;
            const avgPrice = (typeof data.avg_price === 'number') ? data.avg_price : 0;
            // Insight 1: Efficiency
            insights.push({
                title: 'Efficiency Rating',
                content: `Your current efficiency score is <b>${efficiency}</b> (Waste: ${waste}%). ${
                    waste < 10 ? 'Excellent waste management!' :
                    waste < 20 ? 'Good performance, but there is room for improvement.' :
                    'Waste is high‚Äîconsider reducing order quantities or improving sales strategies.'
                }`
            });
            // Insight 2: Sales Trend
            insights.push({
                title: 'Sales Trend',
                content: `Your sales trend is <b>${salesTrend > 0 ? 'increasing' : salesTrend < 0 ? 'decreasing' : 'stable'}</b> (${salesTrend.toFixed(2)} per week). ${
                    salesTrend > 0 ? 'Keep up the good work and monitor for further growth.' :
                    salesTrend < 0 ? 'Investigate possible causes for declining sales.' :
                    'Sales are stable. Consider new promotions to boost growth.'
                }`
            });
            // Insight 3: Revenue & Pricing
            insights.push({
                title: 'Revenue & Pricing',
                content: `Total revenue: <b>‚Ç±${totalRevenue}</b>. Average price per kg: <b>‚Ç±${avgPrice}</b>. ${
                    priceTrend > 0 ? 'Prices are trending up‚Äîwatch for customer sensitivity.' :
                    priceTrend < 0 ? 'Prices are trending down‚Äîensure profitability is maintained.' :
                    'Prices are stable.'
                }`
            });
            // Insight 4: Actionable Tip
            insights.push({
                title: 'Actionable Tip',
                content: (
                    waste > 20 ? 'Waste is high‚Äîconsider lowering orders or promoting discounts.' :
                    (salesTrend < 0 ? 'Try new marketing strategies to boost sales.' :
                    'Maintain current ordering and pricing strategies.')
                )
            });
            insightsGrid.innerHTML = insights.map(i => `<div class="insight-card"><h4>${i.title}</h4><p>${i.content}</p></div>`).join('');
        }
        // Call this after loading analytics data
        function updateResearchInsightsFromAPI() {
            // Try to use real analyticsSummary/trends
            if (window.analyticsSummary && window.analyticsSummary.total_entries && window.analyticsSummary.total_entries > 0) {
                generateResearchInsights(window.analyticsSummary);
            } else {
                // Try to fetch from API directly if not already loaded
                getJson('/api/analytics', 15000).then(data => generateResearchInsights(data));
            }
        }
        document.addEventListener('DOMContentLoaded', updateResearchInsightsFromAPI);
    </script>
</body>
</html>
